<%@page import="java.util.Arrays"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>    
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>    
<style>
	.gridDIV{
		display: grid;
		grid-template-columns: 2fr 3fr;
	}
	.redfont{
		color: red;
	}
	.attendTable{
	 table-layout: fixed;
	 width:100%;	
	}
	.attendTableDiv {
		overflow: auto;
		min-width: 500px;
	}
</style>
<div class="gridDIV" >
	<div class="space m-3 p-5">
		<div>
			<h4 class="mb-4">
				<ion-icon name="stop-outline" role="img" class="md hydrated">
				</ion-icon> ì „ìì¶œê²° ì‹œìŠ¤í…œ ì‚¬ìš©ì•ˆë‚´
			</h4>
			<div class="desc-space pt-4 p-3">
			<p class="redfont">&emsp; ğŸš©êµìˆ˜ë‹˜, ê°•ì˜ì‹¤ ì¶œì„ì„ ì˜¤í”ˆí•˜ê¸° ì „, ëª¨ë“  í•™ìƒë“¤ì—ê²Œ ë¡œê·¸ì¸ì´ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
			<p>&emsp; -- ì „ìì¶œê²° ì‹œìŠ¤í…œ ì´ìš©ìˆœì„œ -- </p>
			<p>&emsp; 1. ê°•ì˜ì‹¤ ì¶œì„ ì˜¤í”ˆì„ ì„ íƒí•œë‹¤.  </p>
			<p>&emsp; 2. í•™ìƒë“¤ì˜ ì¶œì„ì„ ì‘ë‹µì„ ê¸°ë‹¤ë¦°ë‹¤.</p>
			<p>&emsp; 3. ì ë‹¹í•œ ì‹œê°„ì„ ì œê³µí–ˆë‹¤ë©´, ê°•ì˜ì‹¤ ì¶œì„ì„ ë‹«ì•„ì£¼ì„¸ìš”.</p>
			<p>&emsp; 4. í•™ìƒë“¤ì˜ ì¶œì„ì„ í™•ì¸í•˜ê³  ì €ì¥ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
			<p>&emsp; 5. ë“±ë¡ëœ ë°ì´í„°ì˜ ê°¯ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
			</div>
		</div><br><br>
		<div class="">
			<img src="${cPath }/resources/img/autoAttend.jpg" width="600px"/>
		</div>
	</div>
	<div class="space m-3 p-5 attendTableDiv overflow-scroll scrollable-content">
		<button class="openBtn" data-role="connect">ROOM ID(${lectNo}) ê°•ì˜ì‹¤ ì¶œì„ ì˜¤í”ˆ!</button><br><br>
		<button class="openBtn" data-role="disconnect" disabled="disabled">ROOM ID(${lectNo}) ê°•ì˜ì‹¤ ì¶œì„ ì¢…ë£Œ!</button><br><br>
		<table class="table table-hover text-center underbar attendTable">
			<thead>
				<tr>
					<th> <h4>ì¶œì„ í•™ìƒ ë¦¬ìŠ¤íŠ¸</h4> </th>
				</tr>
			</thead>
			<tbody id="stdTBODY">
				<c:forEach items='${cosStuList }' var="usr">
					<tr>
						<td id="stu_${usr.stuNo}" data-stu-no="${usr.stuNo}">
							${usr.student.memName } :
<%-- 							${usr.student.memName } : <span class="bg-danger outAttend">ì¶œì„</span> --%>
							<input type="radio" name="${usr.stuNo}_attendState_in" value="D001" />
							<label for="${usr.stuNo}_attendState_in" class="outAttend" >ì¶œì„</label>
							
							<input type="radio" name="${usr.stuNo}_attendState_out" value="D002" checked="checked"/>
							<label for="${usr.stuNo}_attendState_out" class="bg-danger outAttend">ê²°ì„</label>
						</td>
					</tr>
				</c:forEach>
			</tbody>
			<tfoot>
				<tr>
					<td>
						<button class="openBtn saveBtn btn btn-primary" disabled="disabled">ì €ì¥</button>
					</td>
				</tr>
			</tfoot>
		</table>
		<security:authentication property="principal.realUser" var="authUser" />
	</div>
</div>
<script>
	const ROOMID = `${lectNo}`;
	const openBtns = document.querySelectorAll(".openBtn");
	let client = null;
	
	let inOriginRadio = document.querySelectorAll("input[type='radio']:not(:checked)");
	let outOriginRadio = document.querySelectorAll("input[type='radio']:checked");
	
	for(let i=0; i<inOriginRadio.length; i++){
		outOriginRadio[i].addEventListener("change", function(){
			inOriginRadio[i].checked = false;
			inOriginRadio[i].nextElementSibling.classList.remove("bg-success", "inAttend");
			outOriginRadio[i].checked = true;
			outOriginRadio[i].nextElementSibling.classList.add("bg-danger", "outAttend");
		})
		
		inOriginRadio[i].addEventListener("change", function(){
			inOriginRadio[i].checked = true;
			inOriginRadio[i].nextElementSibling.classList.add("bg-success", "inAttend");
			outOriginRadio[i].checked = false;
			outOriginRadio[i].nextElementSibling.classList.remove("bg-danger", "outAttend");
		})
	}
	
	
	function openBtnOn(targetBtn){
		
		// ìŠ¤í†°í”„ ê°ì²´ ìƒì„±
		client = new StompJs.Client({
			brokerURL:"ws://localhost${cPath}/ws/classroom",
			debug:function(str){
				console.log(str);
			},
			// ì—°ê²°ë˜ê³ ì„œ ìˆ˜í–‰í•˜ëŠ” ë‚´ìš©
			onConnect:function(frame){
				const subscription1 = this.subscribe(`/user/classroom/\${ROOMID}`, function(msgFrame){
					let payload = JSON.parse(msgFrame.body);
					let stdTD = stdTBODY.querySelector(`#stu_\${payload.sender}`);
					if(stdTD){
						
						let radios = stdTD.querySelectorAll("input[type='radio']");
						let inRadio = radios[0];
						let outRadio = radios[1];
						
						console.log(inRadio, ":inRadio");
						console.log(outRadio, ":outRadio");
						
						inRadio.checked = true;
						inRadio.nextElementSibling.classList.add("bg-success", "inAttend");
						outRadio.checked = false;
						outRadio.nextElementSibling.classList.remove("bg-danger", "outAttend");
					}
				});

				
				this.publish({
					destination:"/classroom/open",
					body:JSON.stringify({
						classRoomId:ROOMID,
						professor:"${authUser.proNo}"
					}),
					headers:{"content-type":"application/json"}
				})
			}
		});
		client.activate();
	}
	
	
	// ìœ„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´,
	openBtns[0].addEventListener("click",()=>{
		// ë²„íŠ¼ í† ê¸€í•˜ê³ , 
		openBtns[0].disabled = true;
		openBtns[1].disabled  = false;
		openBtns[2].disabled  = true;
		
		// ì—°ê²°
		openBtnOn(openBtns[0]);
	})

	// ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, 
	openBtns[1].addEventListener("click",()=>{
		// ë²„íŠ¼ í† ê¸€í•˜ê³ , 
		openBtns[1].disabled = true;
		openBtns[0].disabled  = false;
		openBtns[2].disabled  = false;
		
		// ì—°ê²° ì¢…ë£Œ!
		client.deactivate();
	})

	// ì´ê±° ë‹¤ ë°”ê¿” 
	let saveBtn = document.querySelector(".saveBtn")
	saveBtn.addEventListener("click", ()=>{
		// ì²´í¬ëœ ë¼ë””ì˜¤ë“¤ ì „ë¶€ëª¨ì—¬!
		let checkedRadios = document.querySelectorAll("input[type='radio']:checked");
		
		//controllerë¡œ ì „ì†¡í• 
		//ê²½ë¡œ ì„¤ì •
		let attendUrl = `\${$.CPATH}/attendance/attendInsert.do`
		
		//ë°ì´í„° ì„¤ì •
		let lectNo = ${lectNo};
		// í•™ìƒë“¤ì˜ í•™ë²ˆ ë½‘ì•„ë‚´ì.
		// í•™ìƒë§ˆë‹¤ ì¶œì„, ê²°ì„ valueë¥¼ ë„£ì€ ê°ì²´ë¥¼ ë§Œë“¤ì!
		let stus = [];
		attendDatas = [];
		checkedRadios.forEach(function(checkedRadio){
			attendData = {
				stuNo : checkedRadio.parentNode.dataset.stuNo,
				attendState : checkedRadio.value,
				lectNo : lectNo
			}
			attendDatas.push(attendData);
		})
		 
		console.log(attendDatas);

		//ajaxë¡œ ì „ì†¡í•˜ì.
		$.ajax({
			url : attendUrl,
			method : "post", 
			data : JSON.stringify(attendDatas),
			dataType : "json",
			contentType : "application/json"
		}).done(function(resp, textStatus, jqXHR) {
			alert("ì¶œì„ ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ : " + resp);
		})
		
	});
	
</script>